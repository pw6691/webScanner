<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Beeper</title>
  <style>
    .container {
      width: 500px;
      padding: 20px;
    }
    .parameter-item {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .parameter-name {
      font-weight: bold;
      margin-right: 20px;
      padding-left: 20px; 
      width: 150px;
    }
    .parameter-dropdown select {
      width: 250px;
    }
    input[type="file"] {
      margin-bottom: 20px;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Beeper</h2>
    <input type="file" id="fileInput" accept=".scndef">
    <div class="parameter-list" id="parameterList"></div>
    <button id="generateXmlButton">Generate XML</button>
  </div>

  <script>
    let initialValues = {};
    let parameterIds = {};
    let optionCaptions = {};

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
          displayParameterNames(xmlDoc);
        };
        reader.readAsText(file);
      }
    });

    function displayParameterNames(xmlDoc) {    
      const groups = xmlDoc.getElementsByTagName('group');
      const parameterList = document.getElementById('parameterList');
      parameterList.innerHTML = ''; 
      initialValues = {};
      parameterIds = {};
      optionCaptions = {};

      for (let i = 0; i < groups.length; i++) {
        const groupName = groups[i].getAttribute('name');
        if (groupName === 'Beeper') {
          const parameters = groups[i].getElementsByTagName('parameter');
          for (let j = 0; j < parameters.length; j++) {
            const name = parameters[j].getAttribute('name');
            const id = parameters[j].getAttribute('id');
            if (name && id) {
              const parameterItem = document.createElement('div');
              parameterItem.classList.add('parameter-item');

              const nameContainer = document.createElement('div');
              nameContainer.classList.add('parameter-name');

              const dropdownContainer = document.createElement('div');
              dropdownContainer.classList.add('parameter-dropdown');

              const nameLabel = document.createElement('span');
              nameLabel.textContent = name;
              nameContainer.appendChild(nameLabel);

              const dropdown = document.createElement('select');
              const options = parameters[j].getElementsByTagName('option');
              for (let k = 0; k < options.length; k++) {
                const option = document.createElement('option');
                const caption = options[k].getElementsByTagName('caption')[0];
                if (caption) {
                  option.text = caption.textContent;
                  option.value = options[k].getAttribute('value');
                  dropdown.add(option);

                  // Store the text-id for each option
                  const textId = caption.getAttribute('text-id');
                  if (!optionCaptions[name]) {
                    optionCaptions[name] = {};
                  }
                  optionCaptions[name][option.value] = textId;
                }
              }

              // Setting first option as default value
              if (dropdown.options.length > 0) {
                dropdown.selectedIndex = 0;
                initialValues[name] = dropdown.value;
                parameterIds[name] = id;
              }

              dropdownContainer.appendChild(dropdown);

              parameterItem.appendChild(nameContainer);
              parameterItem.appendChild(dropdownContainer);
              parameterList.appendChild(parameterItem);
            }
          }
          break;
        }
      }
    }

    document.getElementById('generateXmlButton').addEventListener('click', function() {
      const parameterList = document.getElementById('parameterList');
      const items = parameterList.getElementsByClassName('parameter-item');
      const result = [];

      for (let i = 0; i < items.length; i++) {
        const name = items[i].getElementsByClassName('parameter-name')[0].textContent;
        const dropdown = items[i].getElementsByTagName('select')[0];
        const currentValue = dropdown.value;

        if (currentValue !== initialValues[name] && currentValue !== '') {
          const id = parameterIds[name];
          const textId = optionCaptions[name][currentValue];
          result.push('<parameter name="' + name + '" id="' + id + '"><option value="' + currentValue + '"><caption text-id="' + textId + '"></caption></option></parameter>');
        }
      }

      const xmlContent = '<parameters>\n' + result.join('\n') + '\n</parameters>';
      const blob = new Blob([xmlContent], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'changed_parameters.xml';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    });
  </script>
</body>
</html>
